{% extends "base.html" %}
{% load static %}
{% block title %}{{ app.title }} - JN App Store{% endblock %}
{% block extra_css %}<link rel="stylesheet" href="{% static 'css/app_detail_new.css' %}">{% endblock %}

{% block content %}

<!-- HERO BANNER SECTION -->
<div class="app-hero">
  <div class="hero-container">
    <div class="hero-left">
      <!-- App Icon -->
      <div class="app-icon">
        {% if app.cover_image %}<img src="{{ app.cover_image.url }}" alt="{{ app.title }}">{% else %}{{ app.title|first|upper }}{% endif %}
      </div>

      <!-- App Title & Basic Info -->
      <div class="hero-info">
        <h1 class="app-title">{{ app.title }}</h1>
        <p class="app-developer">by {{ app.owner.first_name|default:app.owner.username }}</p>
        
        <div class="app-rating">
          <span class="rating-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
          <span class="rating-text">{{ app.avg_rating|default_if_none:"0"|floatformat:1 }}/5 ({{ reviews_count }} reviews)</span>
        </div>

        <p class="app-brief">{{ app.short_description|default:"A great app to explore" }}</p>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="hero-stats">
      <div class="stat-item">
        <div class="stat-label">Downloads</div>
        <div class="stat-value">{{ app.downloads|default:0 }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Version</div>
        <div class="stat-value">{{ app.version|default:"1.0" }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Size</div>
        <div class="stat-value">{{ app.size_mb|floatformat:1 }}MB</div>
      </div>
    </div>
  </div>
</div>

<!-- ACTION BAR -->
<div class="action-bar">
  <div class="action-container">
    <a href="{% url 'apps:download' app.slug %}" class="btn btn-primary btn-large">
      <span class="btn-icon">‚¨á</span> Download
    </a>
    {% if user.is_authenticated %}
      <a href="{% url 'reviews:add' app.slug %}" class="btn btn-secondary">
        <span class="btn-icon">‚úé</span> Review
      </a>
    {% else %}
      <a href="{% url 'accounts:login' %}" class="btn btn-secondary">
        <span class="btn-icon">üîê</span> Login
      </a>
    {% endif %}
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="app-content">
  <div class="content-container">
    
    <!-- LEFT COLUMN -->
    <div class="content-left">
      
      <!-- About Section -->
      <section class="content-section">
        <h2 class="section-header">About this app</h2>
        <p class="section-text">{{ app.description|default:"No description available" }}</p>
      </section>

      <!-- Screenshots Section -->
      {% if app.screenshots.all or app.cover_image %}
      <section class="content-section">
        <h2 class="section-header">Screenshots</h2>
        {% if app.screenshots.all %}
          <div class="gallery-container">
            <div class="gallery-main">
              <img id="main-screenshot" src="{{ app.screenshots.first.image.url }}" alt="Screenshot">
            </div>
            {% if app.screenshots.count > 1 %}
            <div class="gallery-thumbs">
              {% for screenshot in app.screenshots.all %}
              <img 
                src="{{ screenshot.image.url }}" 
                alt="Thumbnail"
                class="thumb {% if forloop.first %}active{% endif %}"
                onclick="changeScreenshot(this, '{{ screenshot.image.url }}')"
              >
              {% endfor %}
            </div>
            {% endif %}
          </div>
        {% else %}
          <div class="empty-section">
            <p>No screenshots available</p>
          </div>
        {% endif %}
      </section>
      {% endif %}

      <!-- What's New / Details -->
      <section class="content-section">
        <h2 class="section-header">App Details</h2>
        <div class="details-grid">
          <div class="detail-item">
            <label>Current Version</label>
            <value>{{ app.version|default:"1.0" }}</value>
          </div>
          <div class="detail-item">
            <label>Android Requirements</label>
            <value>{{ app.min_android_version }} and up</value>
          </div>
          <div class="detail-item">
            <label>Min API Level</label>
            <value>{{ app.min_api_level }}</value>
          </div>
          <div class="detail-item">
            <label>Target API Level</label>
            <value>{{ app.target_api_level }}</value>
          </div>
          <div class="detail-item">
            <label>Price</label>
            <value>{% if app.is_free %}<span class="badge badge-free">FREE</span>{% else %}<span>${{ app.price|floatformat:2 }}</span>{% endif %}</value>
          </div>
          <div class="detail-item">
            <label>Updated</label>
            <value>{{ app.updated_at|date:"M d, Y" }}</value>
          </div>
        </div>
      </section>

      <!-- Developer Section -->
      <section class="content-section">
        <h2 class="section-header">Developer</h2>
        <div class="developer-card">
          <div class="dev-name">{{ app.developer_name|default:app.owner.get_full_name|default:app.owner.username }}</div>
          {% if app.website_url %}
          <div class="dev-link"><a href="{{ app.website_url }}" target="_blank">Visit Website</a></div>
          {% endif %}
          {% if app.support_email %}
          <div class="dev-link"><a href="mailto:{{ app.support_email }}">Contact Support</a></div>
          {% endif %}
        </div>
      </section>

    </div>

    <!-- RIGHT COLUMN SIDEBAR -->
    <div class="content-right">
      
      <!-- Price & Download Card -->
      <div class="info-card featured">
        <div class="card-badge">{% if app.is_free %}FREE{% else %}PAID{% endif %}</div>
        <div class="card-price">
          {% if app.is_free %}
            <div class="price-text">Free</div>
          {% else %}
            <div class="price-amount">${{ app.price|floatformat:2 }}</div>
          {% endif %}
        </div>
        <a href="{% url 'apps:download' app.slug %}" class="btn btn-primary">Get Now</a>
      </div>

      <!-- Stats Card -->
      <div class="info-card">
        <div class="card-title">Stats</div>
        <div class="stats-list">
          <div class="stats-row">
            <span class="stats-label">Rating</span>
            <strong class="stats-value">{{ app.avg_rating|default_if_none:"0"|floatformat:1 }}/5</strong>
          </div>
          <div class="stats-row">
            <span class="stats-label">Reviews</span>
            <strong class="stats-value">{{ reviews_count }}</strong>
          </div>
          <div class="stats-row">
            <span class="stats-label">Downloads</span>
            <strong class="stats-value">{{ app.downloads|default:0 }}</strong>
          </div>
          <div class="stats-row">
            <span class="stats-label">Published</span>
            <strong class="stats-value">{{ app.created_at|date:"M d, Y" }}</strong>
          </div>
        </div>
      </div>

      <!-- System Requirements -->
      <div class="info-card">
        <div class="card-title">Requirements</div>
        <div class="req-list">
          <div class="req-item">
            <span>Min Android</span>
            <strong>{{ app.min_android_version }}</strong>
          </div>
          <div class="req-item">
            <span>Size</span>
            <strong>{{ app.size_mb|floatformat:1 }}MB</strong>
          </div>
        </div>
      </div>

    </div>

  </div>
</div>

<!-- REVIEWS SECTION -->
<div class="reviews-section">
  <div class="section-container">
    <h2 class="section-header">Reviews ({{ reviews_count }})</h2>
    
    {% if reviews %}
    <div class="reviews-list">
      {% for r in reviews %}
      <div class="review-item">
        <div class="review-header">
          <strong class="review-author">{{ r.user.first_name|default:r.user.username }}</strong>
          <span class="review-rating">‚òÖ {{ r.rating }}.0</span>
        </div>
        <div class="review-date">{{ r.created_at|date:"M d, Y" }}</div>
        {% if r.comment %}
        <p class="review-text">{{ r.comment }}</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="empty-reviews">
      <p>No reviews yet. Be the first to review!</p>
      {% if user.is_authenticated %}
        <a href="{% url 'reviews:add' app.slug %}" class="btn btn-secondary">Write a Review</a>
      {% else %}
        <a href="{% url 'accounts:login' %}" class="btn btn-secondary">Login to Review</a>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<!-- FOOTER -->
<div class="app-footer">
  <div class="section-container">
    <h3>Developer Responsibility</h3>
    <p>This app is distributed by {{ app.owner.get_full_name|default:app.owner.username }}. The developer is solely responsible for the app's content and legality.</p>
    {% if app.privacy_policy_url or app.terms_url %}
    <div class="footer-links">
      {% if app.privacy_policy_url %}<a href="{{ app.privacy_policy_url }}" target="_blank">Privacy Policy</a>{% endif %}
      {% if app.terms_url %}<a href="{{ app.terms_url }}" target="_blank">Terms</a>{% endif %}
    </div>
    {% endif %}
  </div>
</div>

<script>
function changeScreenshot(el, url) {
  document.getElementById('main-screenshot').src = url;
  document.querySelectorAll('.gallery-thumbs .thumb').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
}
</script>


  <div class="app-hero-container">
    <div class="app-hero-left">
      <!-- App Cover Image -->
      <div class="app-cover">
        {% if app.cover_image %}<img src="{{ app.cover_image.url }}" alt="{{ app.title }}">{% else %}{{ app.title|first|upper }}{% endif %}
      </div>

      <!-- App Info -->
      <div class="app-hero-info">
        <h1 class="app-title">{{ app.title }}</h1>
        
        <div class="app-meta">
          <span class="app-category"><span class="app-category-icon">üì±</span> {{ app.category.name }}</span>
          <span class="app-author">by <strong>{{ app.owner.first_name|default:app.owner.username }}</strong></span>
        </div>

        <div class="app-meta-info">
          <span class="meta-item"><span class="meta-icon">üì¶</span>{{ app.size_mb|floatformat:2 }} MB</span>
          <span class="meta-divider">‚Ä¢</span>
          <span class="meta-item"><span class="meta-icon">üîñ</span>v{{ app.version|default:"1.0" }}</span>
          <span class="meta-divider">‚Ä¢</span>
          <span class="meta-item"><span class="meta-icon">üìÖ</span>{{ app.updated_at|date:"M d, Y" }}</span>
        </div>

        <!-- Stats -->
        <div class="app-stats">
          <div class="app-stat">
            <div class="app-stat-icon rating">‚≠ê</div>
            <div class="app-stat-content">
              <div class="app-stat-value">{{ app.avg_rating|default_if_none:"0"|floatformat:1 }}/5</div>
              <div class="app-stat-label">({{ reviews_count }} reviews)</div>
            </div>
          </div>
          <div class="app-stat">
            <div class="app-stat-icon downloads">‚¨á</div>
            <div class="app-stat-content">
              <div class="app-stat-value">{{ app.downloads|default:0 }}</div>
              <div class="app-stat-label">downloads</div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="app-actions">
          <a href="{% url 'apps:download' app.slug %}" class="btn btn-primary btn-lg">
            <span class="btn-icon">‚Üì</span>
            <span class="btn-text">Download Now</span>
          </a>
          {% if user.is_authenticated %}
            <a href="{% url 'reviews:add' app.slug %}" class="btn btn-secondary">
              <span class="btn-icon">‚úé</span>
              <span>Write Review</span>
            </a>
          {% else %}
            <a href="{% url 'accounts:login' %}" class="btn btn-secondary">
              <span class="btn-icon">üîê</span>
              <span>Login</span>
            </a>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- SIDEBAR - Quick Info (Like Play Store) -->
    <div class="app-sidebar">
      <div class="info-box">
        <div class="info-box-icon">üì¶</div>
        <div class="info-box-label">File Size</div>
        <div class="info-box-value">{{ app.size_mb|floatformat:1 }}MB</div>
      </div>

      <div class="info-box">
        <div class="info-box-icon">üîñ</div>
        <div class="info-box-label">Version</div>
        <div class="info-box-value">{{ app.version|default:"1.0" }}</div>
      </div>

      <div class="info-box">
        <div class="info-box-icon">ü§ñ</div>
        <div class="info-box-label">Min Android</div>
        <div class="info-box-value">{{ app.min_android_version }}</div>
        <div class="info-box-subtext">API {{ app.min_api_level }}</div>
      </div>

      <div class="info-box">
        <div class="info-box-icon">üìä</div>
        <div class="info-box-label">Target Android</div>
        <div class="info-box-value">{{ app.target_android_version }}</div>
        <div class="info-box-subtext">API {{ app.target_api_level }}</div>
      </div>

      <div class="info-box">
        <div class="info-box-icon">‚¨áÔ∏è</div>
        <div class="info-box-label">Downloads</div>
        <div class="info-box-value">{{ app.downloads|default:0 }}</div>
      </div>

      <div class="info-box {% if app.is_free %}badge-free{% else %}badge-paid{% endif %}">
        <div class="info-box-icon">üí∞</div>
        <div class="info-box-label">Price</div>
        <div class="info-box-value"><span class="badge-text">{% if app.is_free %}FREE{% else %}${{ app.price|floatformat:2 }}{% endif %}</span></div>
      </div>
    </div>
  </div>
</div>

<!-- MAIN CONTENT AREA -->
<div class="app-main">
  <!-- Full-width Cover Image -->
  {% if app.cover_image %}
    <img src="{{ app.cover_image.url }}" alt="{{ app.title }}" class="app-image-full">
  {% endif %}

  <!-- Content Wrapper (2 Column Layout) -->
  <div class="app-content-wrapper">
    <!-- LEFT COLUMN -->
    <div>
      <!-- About This App -->
      {% if app.description %}
        <div class="section-card featured">
          <h2 class="section-title">üìù About This App</h2>
          <p class="section-text">{{ app.description }}</p>
        </div>
      {% endif %}

      <!-- Key Features -->
      {% if app.short_description %}
        <div class="section-card">
          <h2 class="section-title">‚ú® Key Features</h2>
          <p class="section-text">{{ app.short_description }}</p>
        </div>
      {% endif %}

      <!-- Screenshots Gallery -->
      {% if app.screenshots.all %}
        <div class="section-card featured">
          <h2 class="section-title">üì∏ Screenshots</h2>
          <div class="screenshots-container">
            <div class="screenshots-main">
              <img 
                id="main-screenshot" 
                src="{{ app.screenshots.first.image.url }}" 
                alt="Screenshot" 
                class="main-screenshot"
              >
              {% if app.screenshots.first.caption %}
                <p class="screenshot-caption">{{ app.screenshots.first.caption }}</p>
              {% endif %}
            </div>
            
            {% if app.screenshots.count > 1 %}
              <div class="screenshots-thumbnails">
                {% for screenshot in app.screenshots.all %}
                  <div 
                    class="screenshot-thumb {% if forloop.first %}active{% endif %}"
                    onclick="changeScreenshot(this, '{{ screenshot.image.url }}', '{{ screenshot.caption }}')"
                    role="button"
                    aria-label="Screenshot {{ forloop.counter }}"
                  >
                    <img src="{{ screenshot.image.url }}" alt="Thumbnail {{ forloop.counter }}">
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      {% else %}
        <div class="section-card featured">
          <h2 class="section-title">üì∏ Screenshots</h2>
          <div class="screenshots-empty">
            <div class="screenshots-empty-icon">üñºÔ∏è</div>
            <div class="screenshots-empty-content">
              <h3>No Screenshots Available</h3>
              <p>This app doesn't have screenshots yet. Get started by installing and exploring the app yourself!</p>
              <div class="screenshots-features">
                <div class="feature-item">
                  <span class="feature-icon">‚ú®</span>
                  <span class="feature-text">Discover Features</span>
                </div>
                <div class="feature-item">
                  <span class="feature-icon">‚ö°</span>
                  <span class="feature-text">Fast & Smooth</span>
                </div>
                <div class="feature-item">
                  <span class="feature-icon">üéØ</span>
                  <span class="feature-text">User Friendly</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Android Requirements (Like APK Pure) -->
      <div class="section-card info">
        <h2 class="section-title">ü§ñ Android Requirements</h2>
        <div class="requirements-grid">
          <div class="requirement-item">
            <div class="requirement-label">Minimum Android</div>
            <div class="requirement-value">{{ app.min_android_version }}</div>
            <div class="requirement-api">API Level {{ app.min_api_level }}</div>
          </div>
          <div class="requirement-item">
            <div class="requirement-label">Target Android</div>
            <div class="requirement-value">{{ app.target_android_version }}</div>
            <div class="requirement-api">API Level {{ app.target_api_level }}</div>
          </div>
        </div>
      </div>

      <!-- Developer Information -->
      <div class="section-card developer">
        <h2 class="section-title">üë®‚Äçüíª Developer Information</h2>
        <div class="dev-info-grid">
          <div class="dev-info-item">
            <span class="dev-info-label">Developer:</span>
            <span class="dev-info-value">{{ app.developer_name|default:app.owner.get_full_name|default:app.owner.username }}</span>
          </div>
          {% if app.website_url %}
            <div class="dev-info-item">
              <span class="dev-info-label">Website:</span>
              <span class="dev-info-value"><a href="{{ app.website_url }}" target="_blank">{{ app.website_url|truncatewords:3 }}</a></span>
            </div>
          {% endif %}
          {% if app.developer_email %}
            <div class="dev-info-item">
              <span class="dev-info-label">Email:</span>
              <span class="dev-info-value"><a href="mailto:{{ app.developer_email }}">{{ app.developer_email }}</a></span>
            </div>
          {% endif %}
          {% if app.support_email %}
            <div class="dev-info-item">
              <span class="dev-info-label">Support:</span>
              <span class="dev-info-value"><a href="mailto:{{ app.support_email }}">{{ app.support_email }}</a></span>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Legal & Privacy Links -->
      {% if app.privacy_policy_url or app.terms_url %}
        <div class="section-card legal">
          <h2 class="section-title">‚öñÔ∏è Legal</h2>
          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            {% if app.privacy_policy_url %}
              <a href="{{ app.privacy_policy_url }}" target="_blank" class="btn btn-secondary">üîí Privacy Policy</a>
            {% endif %}
            {% if app.terms_url %}
              <a href="{{ app.terms_url }}" target="_blank" class="btn btn-secondary">üìã Terms</a>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>

    <!-- RIGHT COLUMN -->
    <div>
      <!-- Statistics -->
      <div class="section-card featured">
        <h2 class="section-title">üìä Statistics</h2>
        <div class="stats-grid">
          <div class="stat-row">
            <span class="stat-label">Rating</span>
            <strong class="stat-value highlight">{{ app.avg_rating|default_if_none:"0"|floatformat:1 }}/5.0</strong>
          </div>
          <div class="stat-row">
            <span class="stat-label">Reviews</span>
            <strong class="stat-value">{{ reviews_count }}</strong>
          </div>
          <div class="stat-row">
            <span class="stat-label">Downloads</span>
            <strong class="stat-value">{{ app.downloads|default:0 }}</strong>
          </div>
          <div class="stat-row">
            <span class="stat-label">Published</span>
            <strong class="stat-value">{{ app.created_at|date:"M d, Y" }}</strong>
          </div>
        </div>
      </div>

      <!-- Related Apps (Like TikTok Store) -->
      {% if related_apps %}
        <div class="section-card featured">
          <h2 class="section-title">üîó Similar Apps</h2>
          <div class="related-apps-list">
            {% for related in related_apps %}
              <a href="{% url 'apps:detail' related.slug %}" class="related-app-item">
                <div class="related-app-icon">{{ related.title|first|upper }}</div>
                <div class="related-app-info">
                  <div class="related-app-title">{{ related.title }}</div>
                  <div class="related-app-meta">‚≠ê {{ related.avg_rating|default_if_none:"0"|floatformat:1 }} ‚Ä¢ ‚¨á {{ related.downloads|default:0 }}</div>
                </div>
              </a>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- USER REVIEWS SECTION -->
  <div class="reviews-section">
    <h2 class="reviews-title">‚≠ê User Reviews ({{ reviews_count }})</h2>

    {% if reviews %}
      <div class="reviews-list">
        {% for r in reviews %}
          <div class="review-card">
            <div class="review-header">
              <div class="review-user-info">
                <div class="review-username">{{ r.user.first_name|default:r.user.username }}</div>
                <div class="review-date">{{ r.created_at|date:"M d, Y" }}</div>
              </div>
              <div class="review-rating">
                <span class="review-stars">
                  {% for i in "12345" %}
                    {% if forloop.counter <= r.rating %}‚≠ê{% else %}‚òÜ{% endif %}
                  {% endfor %}
                </span>
                <span>{{ r.rating }}.0</span>
              </div>
            </div>
            {% if r.comment %}
              <p class="review-comment">{{ r.comment }}</p>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="review-empty">
        <div class="review-empty-icon">üìù</div>
        <p class="review-empty-text">No reviews yet. Be the first to review this app!</p>
        {% if user.is_authenticated %}
          <a href="{% url 'reviews:add' app.slug %}" class="btn btn-primary">‚úç Write First Review</a>
        {% else %}
          <a href="{% url 'accounts:login' %}" class="btn btn-secondary">üîê Login to Review</a>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <!-- COPYRIGHT & LEGAL FOOTER -->
  <div class="app-footer">
    <h3 class="app-footer-title">üìã App Information & Copyright</h3>
    <div class="app-footer-content">
      <p><strong>‚ö†Ô∏è Important Notice:</strong> This application is listed on <strong>JN App Store</strong> and is owned/developed by <strong>{{ app.owner.get_full_name|default:app.owner.username }}</strong>. The developer confirms that this is an <strong>original application</strong> and not a copy or unauthorized distribution from Google Play Store, Apple App Store, or any other platform.</p>
      
      <p style="margin-top: 12px; font-size: 12px; color: #95a5a6;">By downloading and using this app, you agree to these terms:</p>
      <ul>
        <li>‚úì The developer owns all intellectual property rights and is solely responsible for the app's legality</li>
        <li>‚úì This is NOT a rebranded, copied, or unauthorized version of apps from other stores</li>
        <li>‚úì The developer has full authority to distribute this app and accepts all legal responsibility</li>
        <li>‚úì The app is provided for personal, non-commercial use only</li>
        <li>‚úì Redistribution, reverse engineering, or commercial use is strictly prohibited</li>
        <li>‚úì JN App Store reserves the right to remove apps that violate copyright or intellectual property laws</li>
        <li>‚úì For copyright claims or IP violations, contact us at <strong>support@jnappstore.com</strong></li>
      </ul>
      
      <p style="margin-top: 12px; font-size: 11px; color: #c0392b;"><strong>‚öñÔ∏è Legal Liability:</strong> The developer, not JN App Store, is fully responsible for any copyright infringement, trademark violations, or intellectual property disputes. Users harmed by copyright violations can pursue legal action against the developer directly.</p>
    </div>
  </div>
</div>

<script>
function changeScreenshot(element, imageUrl, caption) {
  // Update main screenshot
  const mainImg = document.getElementById('main-screenshot');
  mainImg.style.opacity = '0.7';
  
  setTimeout(() => {
    mainImg.src = imageUrl;
    mainImg.style.opacity = '1';
  }, 150);
  
  // Update caption
  const captionEl = document.querySelector('.screenshot-caption');
  if (captionEl && caption) {
    captionEl.textContent = caption;
  }
  
  // Update active thumbnail
  document.querySelectorAll('.screenshot-thumb').forEach(thumb => {
    thumb.classList.remove('active');
  });
  element.classList.add('active');
}
</script>

{% endblock %}
