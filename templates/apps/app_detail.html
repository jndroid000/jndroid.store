{% extends "base.html" %}
{% load static %}
{% block title %}{{ app.title }} - JN App Store{% endblock %}
{% block extra_css %}<link rel="stylesheet" href="{% static 'css/app_detail.css' %}">{% endblock %}

{% block content %}
<div class="appDetail" style="display: grid; grid-template-columns: 1fr; gap: 0;">
  <!-- Main Content Wrapper -->
  <div style="display: grid; grid-template-columns: 1fr 280px; gap: 32px;">
    <!-- Left Column -->
    <div>
      <!-- Header Section -->
      <div class="appHeader">
        <div class="appCover">{{ app.title|first|upper }}</div>
        <div class="appInfo">
          <h1>{{ app.title }}</h1>
          <p style="margin: 8px 0;">
            <a href="{% url 'apps:list' %}?cat={{ app.category.slug }}" style="text-decoration: none; color: var(--primary);">{{ app.category.name }}</a> 
            ‚Ä¢ <span style="text-transform: uppercase; font-size: 12px; color: var(--muted);">{{ app.platform }}</span>
            {% if app.version %} ‚Ä¢ <span>v{{ app.version }}</span>{% endif %}
          </p>
          <p style="color: var(--muted); font-size: 14px; margin: 8px 0;">
            üì¶ {{ app.size_mb|floatformat:2 }} MB
          </p>
          <p style="font-size: 16px; margin: 12px 0; color: var(--text);">
            ‚≠ê <strong>{{ app.avg_rating|default_if_none:"0"|floatformat:1 }}/5</strong>
            <span style="color: var(--muted);">({{ reviews_count }} review{{ reviews_count|pluralize }})</span>
            ‚Ä¢ ‚¨áÔ∏è <strong>{{ app.downloads|default:0 }}</strong> downloads
          </p>
          
          <!-- Action Buttons -->
          <div class="appActions" style="display: flex; gap: 12px; margin-top: 20px;">
            <a href="{% url 'apps:download' app.slug %}" class="btn primary" style="flex:1; text-align: center; padding: 12px; border-radius: var(--radius); text-decoration: none;">‚¨á Download</a>
            {% if user.is_authenticated %}
              <a href="{% url 'reviews:add' app.slug %}" class="btn" style="padding: 12px 20px; border-radius: var(--radius); text-decoration: none; border: 1px solid var(--line); text-align: center;">‚úç Write Review</a>
            {% else %}
              <a href="{% url 'accounts:login' %}" class="btn" style="padding: 12px 20px; border-radius: var(--radius); text-decoration: none; border: 1px solid var(--line); text-align: center;">üîê Login to Review</a>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Cover Image -->
      {% if app.cover_image %}
        <img src="{{ app.cover_image.url }}" alt="{{ app.title }}" style="max-width:100%; width:100%; border-radius:var(--radius); border:1px solid var(--line); margin: 32px 0; display: block;">
      {% endif %}

      <!-- App Information Grid -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid var(--line);">
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); text-align: center;">
          <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Platform</div>
          <div style="font-size: 16px; font-weight: 600;">{{ app.platform|title }}</div>
        </div>
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); text-align: center;">
          <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">File Size</div>
          <div style="font-size: 16px; font-weight: 600;">{{ app.size_mb|floatformat:1 }} MB</div>
        </div>
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); text-align: center;">
          <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Developer</div>
          <div style="font-size: 14px; font-weight: 600;">{{ app.owner.username }}</div>
        </div>
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); text-align: center;">
          <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Updated</div>
          <div style="font-size: 14px; font-weight: 600;">{{ app.updated_at|date:"M d, Y" }}</div>
        </div>
        {% if app.store_name %}
          <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); text-align: center;">
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Store</div>
            <div style="font-size: 14px; font-weight: 600;">üè™ {{ app.store_name }}</div>
          </div>
        {% endif %}
        {% if app.store_email %}
          <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); text-align: center;">
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Contact</div>
            <a href="mailto:{{ app.store_email }}" style="font-size: 14px; font-weight: 600; color: var(--primary); text-decoration: none;">{{ app.store_email }}</a>
          </div>
        {% endif %}
      </div>

      <!-- Description Section -->
      {% if app.description %}
        <div style="margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid var(--line);">
          <h2 style="margin: 0 0 16px; font-size: 20px;">üìù About This App</h2>
          <p style="color: var(--muted); line-height: 1.8; margin: 0;">{{ app.description|linebreaks }}</p>
        </div>
      {% endif %}

      <!-- Short Description -->
      {% if app.short_description %}
        <div style="margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid var(--line);">
          <h3 style="margin: 0 0 12px; font-size: 16px;">Features</h3>
          <p style="color: var(--text); line-height: 1.8; margin: 0;">{{ app.short_description }}</p>
        </div>
      {% endif %}

      <!-- Version Information Section -->
      <div style="margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid var(--line);">
        <h2 style="margin: 0 0 16px; font-size: 20px;">üì¶ Version Information</h2>
        
        <!-- Current Version -->
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border-left: 4px solid #FFD700; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div>
              <div style="font-weight: 600; color: var(--text); font-size: 16px;">üöÄ Current Version</div>
              <div style="font-size: 14px; color: var(--muted); margin-top: 4px;">v{{ app.version|default:"1.0" }}</div>
            </div>
            <a href="{% url 'apps:download' app.slug %}" style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: var(--radius); cursor: pointer; font-size: 13px; text-decoration: none; display: inline-block;">‚¨áÔ∏è Download</a>
          </div>
          <div style="font-size: 12px; color: var(--muted); display: flex; gap: 16px;">
            <span>üì¶ Size: {{ app.size_mb|floatformat:1 }} MB</span>
            <span>üìä Downloads: {{ app.downloads|default:"0" }}</span>
          </div>
        </div>
        
        <!-- Previous Versions -->
        {% if app.versions.all %}
          <div style="margin-bottom: 20px;">
            <h3 style="margin: 0 0 12px; font-size: 16px;">Previous Versions</h3>
            <div style="display: grid; gap: 12px;">
              {% for ver in app.versions.all %}
                <div style="padding: 12px; background: var(--bg-secondary); border-radius: var(--radius); border-left: 4px solid var(--primary);">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-weight: 600; color: var(--text);">v{{ ver.version_number }}</div>
                    <div style="font-size: 12px; color: var(--muted);">{{ ver.released_at|date:"M d, Y" }}</div>
                  </div>
                  {% if ver.description %}
                    <p style="font-size: 13px; color: var(--muted); margin: 6px 0;">{{ ver.description|truncatewords:20 }}</p>
                  {% endif %}
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                    <div style="font-size: 12px; color: var(--muted);">üì¶ {{ ver.size_mb|floatformat:1 }} MB</div>
                    {% if ver.download_link %}
                      <a href="{{ ver.download_link }}" style="background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: var(--radius); cursor: pointer; font-size: 12px; text-decoration: none; display: inline-block;">‚¨áÔ∏è Download</a>
                    {% elif ver.apk_file %}
                      <a href="{{ ver.apk_file.url }}" style="background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: var(--radius); cursor: pointer; font-size: 12px; text-decoration: none; display: inline-block;">‚¨áÔ∏è Download</a>
                    {% else %}
                      <span style="font-size: 11px; color: var(--muted);">No download available</span>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>

      <!-- Copyright & Usage Guidelines Section -->
      <div style="margin-bottom: 32px; padding: 16px; border: 2px solid #dc3545; border-radius: var(--radius); background: rgba(220, 53, 69, 0.05);">
        <h3 style="margin: 0 0 12px; font-size: 16px; color: #dc3545;">‚öñÔ∏è Copyright & Usage Guidelines</h3>
        <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: var(--muted); line-height: 1.8;">
          <li><strong>Ownership:</strong> This application is owned and copyrighted by <strong>{{ app.owner.username }}</strong></li>
          <li><strong>Licensed Use:</strong> Users are granted a personal, non-commercial license to download and use this app</li>
          <li><strong>Restrictions:</strong> Redistribution, reverse engineering, decompilation, or commercial use without permission is strictly prohibited</li>
          <li><strong>Intellectual Property:</strong> All intellectual property rights are retained by the developer</li>
          <li><strong>No Warranty:</strong> The developer is not responsible for any data loss, damages, or issues caused by using this application</li>
          <li><strong>Support:</strong> For licensing inquiries, support, or permissions, please contact the developer directly</li>
          <li><strong>Terms Acceptance:</strong> By downloading this app, you agree to these terms and conditions</li>
        </ul>
      </div>

      <!-- Related Apps Section (Mobile) -->
      {% if related_apps %}
        <div style="display: none; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid var(--line);" class="related-apps-mobile">
          <h2 style="font-size: 20px; margin-bottom: 16px;">üîó More from {{ app.category.name }}</h2>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px;">
            {% for related in related_apps %}
              <a href="{% url 'apps:detail' related.slug %}" style="text-decoration: none;">
                <div style="padding: 12px; background: var(--bg-secondary); border-radius: var(--radius); text-align: center; border: 1px solid var(--line); hover: border-color var(--primary);">
                  <div style="font-size: 32px; margin-bottom: 8px;">{{ related.title|first|upper }}</div>
                  <div style="font-size: 12px; color: var(--text); font-weight: 600; word-break: break-word;">{{ related.title|truncatewords:2 }}</div>
                  <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">‚≠ê {{ related.avg_rating|default_if_none:"0"|floatformat:1 }}/5</div>
                </div>
              </a>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <!-- Reviews Section -->
      <div class="reviewsSection" style="margin-bottom: 32px;">
        <h2 style="font-size: 20px; margin-bottom: 20px;">‚≠ê User Reviews ({{ reviews_count }})</h2>
        
        {% if reviews %}
          <div class="reviewsList" style="display: grid; gap: 16px;">
            {% for r in reviews %}
              <div class="review" style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border-left: 4px solid #FFD700;">
                <div class="reviewHeader" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                  <div>
                    <div style="font-weight: 600; color: var(--text);">{{ r.user.username }}</div>
                    <span style="color: var(--muted); font-size: 12px;">{{ r.created_at|date:"M d, Y" }}</span>
                  </div>
                  <span class="reviewRating" style="font-size: 14px; font-weight: 600;">
                    {% for i in ""|make_list|length|add:"-4"|make_list %}
                      {% if forloop.counter <= r.rating %}‚≠ê{% else %}‚òÜ{% endif %}
                    {% endfor %}
                    {{ r.rating }}/5
                  </span>
                </div>
                {% if r.comment %}
                  <p class="reviewComment" style="color: var(--text); line-height: 1.6; margin: 0;">{{ r.comment }}</p>
                {% else %}
                  <p class="reviewComment" style="color: var(--muted); font-style: italic; margin: 0;">No comment provided</p>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="noReviews" style="padding: 40px; text-align: center; background: var(--bg-secondary); border-radius: var(--radius);">
            <p style="color: var(--muted); margin: 0;">No reviews yet. Be the first to review this app! üéâ</p>
            {% if user.is_authenticated %}
              <a href="{% url 'reviews:add' app.slug %}" class="btn primary" style="margin-top: 16px; display: inline-block; padding: 10px 24px; border-radius: var(--radius); text-decoration: none;">Write First Review</a>
            {% else %}
              <a href="{% url 'accounts:login' %}" class="btn" style="margin-top: 16px; display: inline-block; padding: 10px 24px; border-radius: var(--radius); text-decoration: none; border: 1px solid var(--line);">Login to Review</a>
            {% endif %}
          </div>
        {% endif %}
      </div>

      <!-- Copyright Notice -->
      <div style="margin-top: 32px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border-left: 4px solid var(--primary); font-size: 12px; color: var(--muted); line-height: 1.6;">
        <strong>üìã Information:</strong> This app is listed on JN App Store. The content, features, and availability of this application are the responsibility of the developer. Please respect copyright and intellectual property rights. For inquiries or issues, contact the developer directly.
      </div>
    </div>

    <!-- Right Sidebar (Desktop Only) -->
    {% if related_apps %}
      <aside style="display: none;" class="related-apps-sidebar">
        <div style="position: sticky; top: 20px;">
          <h3 style="font-size: 16px; margin: 0 0 16px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius);">üîó Related Apps</h3>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            {% for related in related_apps %}
              <a href="{% url 'apps:detail' related.slug %}" style="text-decoration: none;">
                <div style="padding: 12px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--line); transition: all 0.2s;">
                  <div style="font-size: 28px; margin-bottom: 6px;">{{ related.title|first|upper }}</div>
                  <div style="font-size: 12px; color: var(--text); font-weight: 600; word-break: break-word; margin-bottom: 4px;">{{ related.title }}</div>
                  <div style="font-size: 11px; color: var(--muted);">‚≠ê {{ related.avg_rating|default_if_none:"0"|floatformat:1 }}/5</div>
                  <div style="font-size: 10px; color: var(--muted); margin-top: 4px;">‚¨á {{ related.downloads|default:0 }} downloads</div>
                </div>
              </a>
            {% endfor %}
          </div>
        </div>
      </aside>
    {% endif %}
  </div>
</div>

<style>
  @media (max-width: 1024px) {
    .appDetail {
      display: grid !important;
      grid-template-columns: 1fr !important;
      gap: 0 !important;
    }
    .appDetail > div {
      display: grid !important;
      grid-template-columns: 1fr !important;
      gap: 0 !important;
    }
    .related-apps-sidebar {
      display: none !important;
    }
    .related-apps-mobile {
      display: block !important;
    }
  }

  @media (min-width: 1025px) {
    .related-apps-sidebar {
      display: block !important;
    }
    .related-apps-mobile {
      display: none !important;
    }
  }
</style>
{% endblock %}
