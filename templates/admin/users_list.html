{% extends "base.html" %}
{% load static %}
{% block title %}Users Management - Admin{% endblock %}

{% block content %}
<div style="padding:20px; max-width:1400px; margin:0 auto;">
  <!-- Header -->
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:32px; padding-bottom:20px; border-bottom:1px solid var(--line);">
    <div>
      <h1 style="margin:0 0 8px; font-size:32px;">ğŸ‘¥ Users Management</h1>
      <p style="color:var(--muted); margin:0;">Total {{ total_users }} users | {{ active_users }} active | {{ verified_users }} verified</p>
    </div>
    <a href="{% url 'admin_panel:dashboard' %}" class="btn secondary" style="padding:10px 20px;">â† Back</a>
  </div>

  <!-- Stats Cards -->
  <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:32px;">
    <div style="padding:16px; background:rgba(59,130,246,0.1); border:1px solid rgba(59,130,246,0.2); border-radius:8px;">
      <div style="font-size:24px; font-weight:bold; color:#3b82f6;">{{ total_users }}</div>
      <div style="font-size:12px; color:var(--muted);">Total Users</div>
    </div>
    <div style="padding:16px; background:rgba(34,197,94,0.1); border:1px solid rgba(34,197,94,0.2); border-radius:8px;">
      <div style="font-size:24px; font-weight:bold; color:#22c55e;">{{ active_users }}</div>
      <div style="font-size:12px; color:var(--muted);">Active Users</div>
    </div>
    <div style="padding:16px; background:rgba(251,191,36,0.1); border:1px solid rgba(251,191,36,0.2); border-radius:8px;">
      <div style="font-size:24px; font-weight:bold; color:#fbbf24;">{{ verified_users }}</div>
      <div style="font-size:12px; color:var(--muted);">Email Verified</div>
    </div>
  </div>

  <!-- Search & Filter Form -->
  <form method="get" style="margin-bottom:24px;">
    <div style="display:grid; grid-template-columns:1fr auto auto; gap:12px; margin-bottom:16px;">
      <!-- Search Box -->
      <input type="text" name="q" placeholder="ğŸ” Search username, email..." value="{{ search_query }}" 
             style="padding:10px; background:rgba(255,255,255,0.04); border:1px solid var(--line); border-radius:6px; color:var(--text);">
      
      <!-- Status Filter -->
      <select name="status" style="padding:10px; background:rgba(255,255,255,0.04); border:1px solid var(--line); border-radius:6px; color:var(--text); cursor:pointer;">
        <option value="">All Status</option>
        <option value="active" {% if status == 'active' %}selected{% endif %}>Active</option>
        <option value="inactive" {% if status == 'inactive' %}selected{% endif %}>Inactive</option>
        <option value="verified" {% if status == 'verified' %}selected{% endif %}>Email Verified</option>
        <option value="unverified" {% if status == 'unverified' %}selected{% endif %}>Email Unverified</option>
        <option value="staff" {% if status == 'staff' %}selected{% endif %}>Staff/Admin</option>
      </select>
      
      <!-- Search Button -->
      <button type="submit" style="padding:10px 20px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Filter</button>
    </div>
  </form>

  <!-- Bulk Actions Form -->
  {% if users %}
  <form method="post" style="margin-bottom:20px;">
    {% csrf_token %}
    
    <!-- Bulk Action Toolbar -->
    <div style="display:flex; gap:12px; padding:12px; background:rgba(255,255,255,0.02); border:1px solid var(--line); border-radius:6px; margin-bottom:16px;">
      <select name="bulk_action" style="padding:8px; background:rgba(255,255,255,0.04); border:1px solid var(--line); border-radius:4px; color:var(--text); cursor:pointer;">
        <option value="">Select Action...</option>
        <option value="activate">âœ… Activate Selected</option>
        <option value="deactivate">âŒ Deactivate Selected</option>
        <option value="delete">ğŸ—‘ï¸ Delete Selected</option>
      </select>
      <button type="submit" style="padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:600;">Apply</button>
      <div style="flex:1;"></div>
      <span id="selected-count" style="color:var(--muted); font-size:14px; align-self:center;">0 selected</span>
    </div>

    <!-- Users Table -->
    <div style="overflow-x:auto; border:1px solid var(--line); border-radius:8px;">
      <table style="width:100%; border-collapse:collapse; font-size:14px;">
        <thead>
          <tr style="background:rgba(255,255,255,0.04); border-bottom:1px solid var(--line);">
            <th style="padding:12px; text-align:center; color:var(--muted); font-weight:500; width:40px;">
              <input type="checkbox" id="select-all" style="cursor:pointer;">
            </th>
            <th style="padding:12px; text-align:left; color:var(--muted); font-weight:500;">Username</th>
            <th style="padding:12px; text-align:left; color:var(--muted); font-weight:500;">Email</th>
            <th style="padding:12px; text-align:center; color:var(--muted); font-weight:500;">Verified</th>
            <th style="padding:12px; text-align:center; color:var(--muted); font-weight:500;">Apps</th>
            <th style="padding:12px; text-align:center; color:var(--muted); font-weight:500;">Status</th>
            <th style="padding:12px; text-align:center; color:var(--muted); font-weight:500;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
            <tr style="border-bottom:1px solid var(--line);">
              <td style="padding:12px; text-align:center;">
                <input type="checkbox" name="selected_users" value="{{ user.pk }}" class="user-checkbox" style="cursor:pointer;">
              </td>
              <td style="padding:12px;">
                <div style="font-weight:600;">{{ user.username }}</div>
                {% if user.is_staff %}<span style="padding:2px 6px; background:rgba(251,191,36,0.2); color:rgba(251,191,36,0.9); font-size:11px; border-radius:3px; margin-top:4px; display:inline-block;">ğŸ‘¨â€ğŸ’¼ ADMIN</span>{% endif %}
              </td>
              <td style="padding:12px; color:var(--muted);">{{ user.email }}</td>
              <td style="padding:12px; text-align:center;">
                {% if user.email_verified %}
                  <span style="color:#22c55e; font-weight:bold;">âœ“</span>
                {% else %}
                  <span style="color:#ef4444; font-weight:bold;">âœ—</span>
                {% endif %}
              </td>
              <td style="padding:12px; text-align:center;">{{ user.apps.count }}</td>
              <td style="padding:12px; text-align:center;">
                {% if user.is_active %}
                  <span style="padding:4px 8px; background:rgba(34,197,94,0.15); border:1px solid rgba(34,197,94,0.3); color:rgba(34,197,94,0.9); border-radius:3px; font-size:12px;">ğŸŸ¢ Active</span>
                {% else %}
                  <span style="padding:4px 8px; background:rgba(251,113,133,0.15); border:1px solid rgba(251,113,133,0.3); color:rgba(251,113,133,0.9); border-radius:3px; font-size:12px;">ğŸ”´ Inactive</span>
                {% endif %}
              </td>
              <td style="padding:12px; text-align:center;">
                <a href="{% url 'admin_panel:users_edit' pk=user.pk %}" style="color:#3b82f6; text-decoration:none; font-weight:600; font-size:12px;">Edit â†’</a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" style="padding:32px; text-align:center; color:var(--muted);">
                ğŸ“­ No users found. Try adjusting your filters.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
  {% endif %}
</div>

<!-- JavaScript for Bulk Selection -->
<script>
  const selectAllCheckbox = document.getElementById('select-all');
  const userCheckboxes = document.querySelectorAll('.user-checkbox');
  const selectedCount = document.getElementById('selected-count');

  function updateCount() {
    const checked = document.querySelectorAll('.user-checkbox:checked').length;
    selectedCount.textContent = `${checked} selected`;
  }

  selectAllCheckbox?.addEventListener('change', function() {
    userCheckboxes.forEach(cb => cb.checked = this.checked);
    updateCount();
  });

  userCheckboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      selectAllCheckbox.checked = Array.from(userCheckboxes).every(c => c.checked);
      updateCount();
    });
  });

  // Prevent accidental form submission
  document.querySelector('form')?.addEventListener('submit', function(e) {
    const action = document.querySelector('[name="bulk_action"]').value;
    const selected = document.querySelectorAll('.user-checkbox:checked').length;
    
    if (!action) {
      e.preventDefault();
      alert('Please select an action');
      return;
    }
    
    if (selected === 0) {
      e.preventDefault();
      alert('Please select at least one user');
      return;
    }
    
    if (!confirm(`Are you sure? This will ${action} ${selected} user(s).`)) {
      e.preventDefault();
    }
  });
</script>

{% endblock %}
