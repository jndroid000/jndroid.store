{% extends "base.html" %}
{% load static %}
{% block title %}Reviews Management - Admin{% endblock %}

{% block content %}
<div style="padding:20px; max-width:1200px; margin:0 auto;">
  <!-- Header -->
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:32px; padding-bottom:20px; border-bottom:1px solid var(--line);">
    <div>
      <h1 style="margin:0 0 8px; font-size:32px;">‚≠ê Reviews Management</h1>
      <p style="color:var(--muted); margin:0;">Total {{ total_reviews }} reviews | {{ pending_reviews }} pending | {{ flagged_reviews }} flagged</p>
    </div>
    <a href="{% url 'admin_panel:dashboard' %}" class="btn secondary" style="padding:10px 20px;">‚Üê Back</a>
  </div>

  <!-- Stats Cards -->
  <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:32px;">
    <div style="padding:16px; background:rgba(59,130,246,0.1); border:1px solid rgba(59,130,246,0.2); border-radius:8px;">
      <div style="font-size:24px; font-weight:bold; color:#3b82f6;">{{ total_reviews }}</div>
      <div style="font-size:12px; color:var(--muted);">Total Reviews</div>
    </div>
    <div style="padding:16px; background:rgba(251,191,36,0.1); border:1px solid rgba(251,191,36,0.2); border-radius:8px;">
      <div style="font-size:24px; font-weight:bold; color:#fbbf24;">{{ pending_reviews }}</div>
      <div style="font-size:12px; color:var(--muted);">Pending</div>
    </div>
    <div style="padding:16px; background:rgba(34,197,94,0.1); border:1px solid rgba(34,197,94,0.2); border-radius:8px;">
      <div style="font-size:24px; font-weight:bold; color:#22c55e;">{{ approved_reviews }}</div>
      <div style="font-size:12px; color:var(--muted);">Approved</div>
    </div>
    <div style="padding:16px; background:rgba(251,113,133,0.1); border:1px solid rgba(251,113,133,0.2); border-radius:8px;">
      <div style="font-size:24px; font-weight:bold; color:#fb7185;">{{ flagged_reviews }}</div>
      <div style="font-size:12px; color:var(--muted);">Flagged</div>
    </div>
  </div>

  <!-- Search & Filter Buttons -->
  <div style="margin-bottom:24px;">
    <!-- Search Form -->
    <form method="get" style="display:flex; gap:12px; margin-bottom:16px;">
      <input type="text" name="q" placeholder="üîç Search reviews..." value="{{ search_query }}" 
             style="flex:1; padding:10px; background:rgba(255,255,255,0.04); border:1px solid var(--line); border-radius:6px; color:var(--text);">
      <button type="submit" style="padding:10px 20px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Search</button>
    </form>

    <!-- Status Filter Buttons -->
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <a href="{% url 'admin_panel:reviews_list' %}" style="padding:10px 16px; background:{% if not status_filter %}rgba(59,130,246,0.2){% else %}rgba(255,255,255,0.04){% endif %}; border:1px solid var(--line); border-radius:6px; color:var(--text); text-decoration:none; font-weight:600; cursor:pointer;">
        üìã All Reviews
      </a>
      <a href="{% url 'admin_panel:reviews_list' %}?status=pending{% if search_query %}&q={{ search_query }}{% endif %}" style="padding:10px 16px; background:{% if status_filter == 'pending' %}rgba(251,191,36,0.2){% else %}rgba(255,255,255,0.04){% endif %}; border:1px solid var(--line); border-radius:6px; color:var(--text); text-decoration:none; font-weight:600; cursor:pointer;">
        ‚è≥ Pending ({{ pending_reviews }})
      </a>
      <a href="{% url 'admin_panel:reviews_list' %}?status=approved{% if search_query %}&q={{ search_query }}{% endif %}" style="padding:10px 16px; background:{% if status_filter == 'approved' %}rgba(34,197,94,0.2){% else %}rgba(255,255,255,0.04){% endif %}; border:1px solid var(--line); border-radius:6px; color:var(--text); text-decoration:none; font-weight:600; cursor:pointer;">
        ‚úÖ Approved ({{ approved_reviews }})
      </a>
      <a href="{% url 'admin_panel:reviews_list' %}?status=flagged{% if search_query %}&q={{ search_query }}{% endif %}" style="padding:10px 16px; background:{% if status_filter == 'flagged' %}rgba(251,113,133,0.2){% else %}rgba(255,255,255,0.04){% endif %}; border:1px solid var(--line); border-radius:6px; color:var(--text); text-decoration:none; font-weight:600; cursor:pointer;">
        ‚ö†Ô∏è Flagged ({{ flagged_reviews }})
      </a>
    </div>
  </div>

  <!-- Bulk Moderation Form -->
  {% if reviews %}
  <form method="post" style="margin-bottom:20px;">
    {% csrf_token %}
    
    <!-- Bulk Action Toolbar -->
    <div style="display:flex; gap:12px; padding:12px; background:rgba(255,255,255,0.02); border:1px solid var(--line); border-radius:6px; margin-bottom:16px;">
      <select name="bulk_action" style="padding:8px; background:rgba(255,255,255,0.04); border:1px solid var(--line); border-radius:4px; color:var(--text); cursor:pointer;">
        <option value="">Select Action...</option>
        <option value="approve">‚úÖ Approve Selected</option>
        <option value="flag">‚ö†Ô∏è Flag Selected</option>
        <option value="delete">üóëÔ∏è Delete Selected</option>
      </select>
      <button type="submit" style="padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:600;">Apply</button>
      <div style="flex:1;"></div>
      <span id="selected-count" style="color:var(--muted); font-size:14px; align-self:center;">0 selected</span>
    </div>

    <!-- Reviews Table -->
    <div style="overflow-x:auto; border:1px solid var(--line); border-radius:8px;">
      <table style="width:100%; border-collapse:collapse; font-size:14px;">
        <thead>
          <tr style="background:rgba(255,255,255,0.04); border-bottom:1px solid var(--line);">
            <th style="padding:12px; text-align:center; color:var(--muted); font-weight:500; width:40px;">
              <input type="checkbox" id="select-all" style="cursor:pointer;">
            </th>
            <th style="padding:12px; text-align:left; color:var(--muted); font-weight:500;">User / App</th>
            <th style="padding:12px; text-align:left; color:var(--muted); font-weight:500;">Comment</th>
            <th style="padding:12px; text-align:center; color:var(--muted); font-weight:500;">Rating</th>
            <th style="padding:12px; text-align:center; color:var(--muted); font-weight:500;">Status</th>
            <th style="padding:12px; text-align:center; color:var(--muted); font-weight:500;">Date</th>
            <th style="padding:12px; text-align:center; color:var(--muted); font-weight:500;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for review in reviews %}
            <tr style="border-bottom:1px solid var(--line);">
              <td style="padding:12px; text-align:center;">
                <input type="checkbox" name="selected_reviews" value="{{ review.pk }}" class="review-checkbox" style="cursor:pointer;">
              </td>
              <td style="padding:12px;">
                <div style="font-weight:600;">{{ review.user.get_full_name|default:review.user.username }}</div>
                <div style="color:var(--muted); font-size:12px;">üì± {{ review.app.title }}</div>
              </td>
              <td style="padding:12px; color:var(--muted); font-size:13px; max-width:400px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="{{ review.comment }}">{{ review.comment }}</td>
              <td style="padding:12px; text-align:center; font-weight:600; color:#fbbf24;">‚≠ê {{ review.rating }}/5</td>
              <td style="padding:12px; text-align:center;">
                {% if review.is_approved %}
                  <span style="padding:4px 8px; background:rgba(34,197,94,0.15); border:1px solid rgba(34,197,94,0.3); color:rgba(34,197,94,0.9); border-radius:3px; font-size:12px;">‚úÖ Approved</span>
                {% elif review.is_flagged %}
                  <span style="padding:4px 8px; background:rgba(251,113,133,0.15); border:1px solid rgba(251,113,133,0.3); color:rgba(251,113,133,0.9); border-radius:3px; font-size:12px;">‚ö†Ô∏è Flagged</span>
                {% else %}
                  <span style="padding:4px 8px; background:rgba(251,191,36,0.15); border:1px solid rgba(251,191,36,0.3); color:rgba(251,191,36,0.9); border-radius:3px; font-size:12px;">‚è≥ Pending</span>
                {% endif %}
              </td>
              <td style="padding:12px; text-align:center; color:var(--muted); font-size:12px;">{{ review.created_at|date:"M d" }}</td>
              <td style="padding:12px; text-align:center;">
                <a href="{% url 'admin_panel:reviews_detail' pk=review.pk %}" style="color:#3b82f6; text-decoration:none; font-weight:600; font-size:12px;">View ‚Üí</a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" style="padding:32px; text-align:center; color:var(--muted);">
                üì≠ No reviews found.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
  {% endif %}
</div>

<!-- JavaScript for Bulk Selection -->
<script>
  const selectAllCheckbox = document.getElementById('select-all');
  const reviewCheckboxes = document.querySelectorAll('.review-checkbox');
  const selectedCount = document.getElementById('selected-count');

  function updateCount() {
    const checked = document.querySelectorAll('.review-checkbox:checked').length;
    selectedCount.textContent = `${checked} selected`;
  }

  selectAllCheckbox?.addEventListener('change', function() {
    reviewCheckboxes.forEach(cb => cb.checked = this.checked);
    updateCount();
  });

  reviewCheckboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      selectAllCheckbox.checked = Array.from(reviewCheckboxes).every(c => c.checked);
      updateCount();
    });
  });

  document.querySelector('form')?.addEventListener('submit', function(e) {
    const action = document.querySelector('[name="bulk_action"]').value;
    const selected = document.querySelectorAll('.review-checkbox:checked').length;
    
    if (!action) {
      e.preventDefault();
      alert('Please select an action');
      return;
    }
    
    if (selected === 0) {
      e.preventDefault();
      alert('Please select at least one review');
      return;
    }
    
    if (!confirm(`Are you sure? This will ${action} ${selected} review(s).`)) {
      e.preventDefault();
    }
  });
</script>

{% endblock %}
